function addClass(e){e=void 0===e?"Class "+(classList.length+1):e;var a=classList.length<colours.length?colours[classList.length]:"#ff0000",t={name:e,colour:a,markers:[]};classList.push(t);var s=$("#classTemplate").clone()[0],n=s.content.children[0];n.id=classList.length-1,n.children[0].querySelector("div").style.background=t.colour,n.children[0].querySelectorAll("span")[0].innerText=t.name,$(n).insertBefore($("#classListEnd")),selectClassIDX(classList.length-1),refreshAssessmentSelect()}function deleteClass(){var e=parseInt($("#modal2").val());if(confirm("Are you sure you want to delete '"+classList[e].name+"'?")){for(var a=0;a<classList[e].markers.length;a++)classList[e].markers[a].setMap(null);classList.splice(e,1);var t=$(".classVal");if(t.eq(e).hasClass("active")&&e>0?t.eq(e-1).addClass("active"):0==e&&t.eq(1).addClass("active"),t.eq(e).remove(),e<t.length)for(var a=e+1;a<t.length;a++)t.eq(a).attr("id",t.eq(a).attr("id")-1);closeColourModal()}refreshAssessmentSelect()}function editClass(e,a){e.stopPropagation();var t=parseInt($(a).parent().parent().attr("id"));$("#modal2").val(t),$("#modal2 #cname").val(classList[t].name),$("#modal2 .demo").minicolors("value",classList[t].colour),Materialize.updateTextFields(),$("#modal2").modal("open")}function clearAllClasses(){for(var e=0;e<classList.length;e++)for(var a=0;a<classList[e].markers.length;a++)classList[e].markers[a].setMap(null);classList=[]}function refreshAssessmentSelect(){$("#assessment_select").children().remove(),classList.forEach(function(e,a){$("#assessment_select").append($("<option>").attr("value",a).text(e.name))}),$("#assessment_select").material_select()}function refreshClassesHTML(){$(".classVal").remove();for(var e=0;e<classList.length;e++){var a=$("#classTemplate").clone()[0],t=a.content.children[0];t.id=e,0===e?t.classList.add("active"):t.classList.remove("active"),t.children[0].querySelector("div").style.background=classList[e].colour,t.children[0].querySelectorAll("span")[0].innerText=classList[e].name,t.children[0].querySelectorAll("span")[1].innerText=classList[e].markers.length,$(t).insertBefore($("#classListEnd"))}}function selectClass(e){selectClassIDX(parseInt($(e).parent().attr("id")))}function selectClassIDX(e){$(".classVal.active").removeClass("active"),$(".classVal:eq("+e+")").addClass("active")}function setClass(){var e=parseInt($("#modal2").val());classList[e].name=$("#modal2 #cname").val(),classList[e].colour=$("#modal2 .demo").minicolors("value"),$(".classVal:eq("+e+") a .legend-colour").css({background:classList[e].colour}),$(".classVal:eq("+e+") a #className").html(classList[e].name),closeColourModal();for(var a=0;a<classList[e].markers.length;a++)classList[e].markers[a].setIcon({path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,fillColor:classList[e].colour,fillOpacity:.6,strokeColor:"white",strokeWeight:.5,scale:4});refreshAssessmentSelect()}function getClasses(){for(var e=[],a=0;a<classList.length;a++){for(var t={name:classList[a].name,colour:classList[a].colour,markers:[]},s=0;s<classList[a].markers.length;s++)t.markers.push([classList[a].markers[s].getPosition().lat(),classList[a].markers[s].getPosition().lng()]);e.push(t)}return e}function closeColourModal(){$("#modal2").modal("close")}function updateRGB(){var e=$(".demo").minicolors("rgbObject");$(".advContainer .input-field input#r").val(e.r),$(".advContainer .input-field input#g").val(e.g),$(".advContainer .input-field input#b").val(e.b)}function giveTraining(){$("#spinner").show(),$("#classify").text("4. Classifying!");var e=buildPostData();$(".button-collapse").sideNav("hide"),$.post("/getmapdata",e,addClassifiedMap,"json").fail(function(e){$("#spinner").hide(),$("#classify").text("4. Classify!"),Materialize.toast(e.responseJSON.message,1e4,"rounded")}).done(function(){$("#results").empty(),$("#resultsTable").empty(),getPerformance(e),$("#histchart").empty(),$("#histchart2").empty(),$("#histchart").append($("<div>").attr("class","container").text("Chart loading").append($("<div>").attr("class","progress").append($("<div>").attr("class","indeterminate")))),$.post("/gethistdata",e,function(e){$("#histchart").empty(),buildChart(e)},"json").fail(function(e){Materialize.toast(e.statusText,1e4,"rounded")})})}function buildPostData(){var e={};return e.region=regionPath(),e.selected=$("#assessment_select").val(),e.predictors=$("#predictors").val(),e.classList=classList.map(function(e,a){var t={};return t.name=e.name,t.lab=a+1,t.colour=e.colour.replace(/#/,""),t.points=e.markers.map(function(e){return e.position.toJSON()}),t}),JSON.stringify(e).replace(/\\r/g,"")}function validateLatLngPair(e){return e instanceof Array?!isNaN(+e[0])&&!isNaN(+e[1]):!isNaN(+e.lat)&&!isNaN(+e.lng)}function validateLine(e){return 3==e.length&&validateLatLngPair(e.slice(0,2))}function buildTrainingKML(){var e=new FileReader,a=$("#kml")[0].files[0];e.onloadend=function(e){if(e.target.readyState===FileReader.DONE){try{var a=$.parseXML(e.target.result)}catch(e){return Materialize.toast("Error: Invalid KML",5e3,"rounded"),void console.log(e)}addRegionFocus(toGeoJSON.kml(a).features[0].geometry.coordinates[0])}},e.readAsText(a)}function buildTrainingCSV(){var e=new FileReader,a=$("#csv")[0].files[0];e.onloadend=function(e){if(e.target.readyState===FileReader.DONE){var a=e.target.result,t=a.split("\n").filter(function(e){return""!==e});clearAllClasses(),$(".classVal").remove();for(var s=0,n=0,o=1;o<t.length;o++){var r=t[o].split(",");if(r[2]=r[2].trim(),validateLine(r))if(google.maps.geometry.poly.containsLocation(new google.maps.LatLng(r[0],r[1]),region)){var l=classList.findIndex(function(e){return e.name===r[2]});-1===l&&(addClass(r[2]),l=classList.length-1);var i=$("li#"+l+" a .badge");i.text(parseInt(i.text())+1);var c=new google.maps.Marker({position:{lat:parseFloat(r[0]),lng:parseFloat(r[1])},map:map,draggable:!0,icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,fillColor:classList[l].colour,fillOpacity:.6,strokeColor:"white",strokeWeight:.5,scale:4}});classList[l].markers.push(c)}else s++;else n++}0!=s&&Materialize.toast(s+" points omitted from CSV for being invalid.",5e3,"rounded"),0!=n&&Materialize.toast(n+" points omitted from CSV for being outside the region.",5e3,"rounded")}},e.readAsText(a)}function buildTrainingJSON(){var e=new FileReader,a=$("#json")[0].files[0];e.onloadend=function(e){e.target.readyState===FileReader.DONE&&loadFromJSON(e.target.result)},e.readAsText(a)}function getPerformance(e){$.post("/getperformance",e,function(e){var a=String(100*e.accuracy).substr(0,6)+"%",t={tooltip:"Resubstitution Accuracy is a measure of how well the model performs when built on all of the training set.",position:"right"};e.producers_accuracy.shift();var s=e.producers_accuracy.map(function(e,a){return[classList[a].name,+String(100*e).substr(0,6)+"%"]});e.consumers_accuracy[0].shift();var n=e.consumers_accuracy[0].map(function(e,a){return[classList[a].name,+String(100*e).substr(0,6)+"%"]});$("#results").append($("<a>").text("Resubstitution Accuracy: "+a).tooltip(t)).append($("<a>").text("Producers Accuracy: ")).append(s.map(function(e){return $("<a>").text(e.join(" "))})).append($("<a>").text("Consumers Accuracy: ")).append(n.map(function(e){return $("<a>").text(e.join(" "))})),$("#resultsTable").append($("<thead>").append($("<tr>"))).append($("<tbody>")),$("#resultsTable thead tr").append($("<th>").text("Accuracy")).append(s.map(function(e){return $("<th>").text(e[0])})),$("#resultsTable tbody").append($("<tr>")).append($("<tr>")),$("#resultsTable tbody tr").eq(0).append($("<td>").text("Producers Accuracy")).append(s.map(function(e){return $("<td>").text(e[1])})),$("#resultsTable tbody tr").eq(1).append($("<td>").text("Consumers Accuracy")).append(n.map(function(e){return $("<td>").text(e[1])}))},"json")}function runAssessment(){$("#assessment_btn").addClass("disabled");var e=buildPostData();$.post("/getassessment",e,function(e){$("#assessmentResults").children().remove(),$("#assessmentResults").append($("<table>").append($("<tr>").append($("<td>").append($("<b>").text("Area:")),$("<td>").text(e.area)),$("<tr>").append($("<td>").append($("<b>").text("EOO:")),$("<td>").text(e.eoo)),$("<tr>").append($("<td>").append($("<b>").text("Units:")),$("<td>").text(e.units))))},"json").fail(function(e){Materialize.toast("Assessment Error",5e3,"rounded")})}function buildChart(e){var a=new google.visualization.arrayToDataTable([["Class","Hectares",{role:"style"}]].concat(classList.map(function(a,t){return[a.name,e.classification[String(t+1)],"color: "+a.colour]}))),t=new google.visualization.ColumnChart($("#histchart")[0]),s={title:"Area in Hectares",legend:{position:"none"},width:300};t.draw(a,s);var n=new google.visualization.ColumnChart($("#histchart2")[0]),o={title:"Area in Hectares",legend:{position:"none"},width:.75*$(window).width(),height:.8*$(window).height()};n.draw(a,o),$("#histchart").on("click",function(){$("#modal1").modal("open")})}function doDownload(e,a){var t=new FileReader;t.onload=function(t){if(window.navigator.msSaveOrOpenBlob)navigator.msSaveBlob(a,e);else{var s=document.createElement("a");s.href=window.URL.createObjectURL(a),s.download=e,document.body.appendChild(s),s.click(),s.remove()}},t.readAsDataURL(a)}function dataDownload(){doDownload("remap_training.json",new Blob([getMapJSON()],{type:"application/json"}))}function prepareDownload(){var e=[];if(e.push("lat,lng,label"),classList.forEach(function(a){var t=a.markers.map(function(e){return e.position.toJSON()});t=t.map(function(e){return[e.lat,e.lng,a.name]}),e=e.concat(t)}),1===e.length)return void Materialize.toast("No training data to download",4e3,"rounded");doDownload("remap_points.csv",new Blob([e.join("\n")],{type:"text/csv"}))}function resetTraining(){confirm("Are you sure you want to clear all training data?")&&(clearAllClasses(),addClass(),refreshClassesHTML(),region.setMap(null),initRegion())}function uploadClick(){$("#modal3").modal("close"),$("#csv")[0].click()}function uploadJSONClick(){$("#modal3").modal("close"),$("#json")[0].click()}function uploadKMLClick(){$("#modal3").modal("close"),$("#kml")[0].click()}function downloadDrive(){var e=buildPostData();$("#g-download a").addClass("subheader"),Materialize.toast("Starting download. This may take a few minutes.",5e3,"rounded"),$("#gtick").hide(),$("#gcross").hide(),$("#gspinner").show(),$.post("/export",e,"json").fail(function(e){$("#gspinner").hide(),$("#gcross").show(),$("#g-download a").removeClass("subheader"),Materialize.toast("Error downloading to Drive.",5e3,"rounded")}).done(function(){$("#gspinner").hide(),$("#gtick").show(),$("#g-download a").removeClass("subheader"),Materialize.toast("Drive download completed!",5e3,"rounded")})}function validateJSON(e){if(!("region"in e))return!1;for(var a=0;a<e.region.length;a++)if(!validateLatLngPair(e.region[a]))return!1;if(!("classes"in e))return!1;for(var a=0;a<e.classes.length;a++){if(!("colour"in e.classes[a]))return!1;if(!("markers"in e.classes[a]))return!1;for(var t=0;t<e.classes[a].markers.length;t++)if(!validateLatLngPair(e.classes[a].markers[t]))return!1}return!0}function loadFromJSON(e){clearAllClasses(),region&&region.setMap(null);var a=null;try{a=JSON.parse(e)}catch(e){return Materialize.toast(e.message,5e3,"rounded"),!1}if(!validateJSON(a))return Materialize.toast("Error in your JSON input. Please check the format.",5e3,"rounded"),!1;addRegionFocus(a.region,json=!0),classList=a.classes,refreshClassesHTML();for(var t=0;t<classList.length;t++)for(var s=0;s<classList[t].markers.length;s++)classList[t].markers[s]=new google.maps.Marker({position:new google.maps.LatLng(classList[t].markers[s][0],classList[t].markers[s][1]),map:map,draggable:!0,icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,fillColor:classList[t].colour,fillOpacity:.6,strokeColor:"white",strokeWeight:.5,scale:4}});return!0}function initRegion(){region&&region.setMap(null),addRegionFocus([{lat:-35.52359131926069,lng:136.38815795898438},{lat:-35.52359131926069,lng:138.25308715820313},{lat:-36.214641115198745,lng:138.25308715820313},{lat:-36.214641115198745,lng:136.38815795898438}],json=!0)}function initAutocomplete(){var e=$("#search")[0],a=new google.maps.places.SearchBox(e);map.addListener("bounds_changed",function(){a.setBounds(map.getBounds())}),a.addListener("places_changed",function(){var e=a.getPlaces();if(0!==e.length){var t=new google.maps.LatLngBounds;e.forEach(function(e){if(!e.geometry)return void console.log("Returned place contains no geometry");e.geometry.viewport?t.union(e.geometry.viewport):t.extend(e.geometry.location)}),map.fitBounds(t)}})}function addLayerControl(e,a,t){var s=document.createElement("div");noUiSlider.create(s,{start:100,connect:[!0,!1],range:{min:0,max:100},step:1,format:wNumb({decimals:0})}),s.noUiSlider.on("update",function(a,t){map.overlayMapTypes.getAt(e-1).setOpacity(parseInt(a[0])/100)});var n=t?"#classification-control":"#predictor-control";$(n).empty().append($("<label>").text(a).append($("<div>").attr("class",".no-ui-slider").append(s)))}function predictorVis(e){var a=$("#predictorVis"),t=a.val(),s={predictor:t,region:regionPath(),sigma:Number($("#sigma").val())};e||(s.mean=vis.mean,s.total_sd=vis.total_sd),$("#sigma").prop("disabled","natural"===t),a.prop("disabled",!0),$("#sigma").material_select(),a.material_select(),$("#spinner").show(),$.post("/getpredictorlayer",JSON.stringify(s),function(e){$("#spinner").hide();var a={getTileUrl:buildGetTileUrl(e.mapid,e.token),tileSize:new google.maps.Size(256,256)},t=new google.maps.ImageMapType(a);0===map.overlayMapTypes.length?map.overlayMapTypes.push(t):map.overlayMapTypes.setAt(0,t),addLayerControl(1,"Predictor",!1);var s=localStorage.getItem("layers");null!=s&&(addClassifiedMap(JSON.parse(s)),localStorage.removeItem("layers")),vis.mean=e.mean,vis.total_sd=e.total_sd},"json").fail(function(e){Materialize.toast("Failed to get predictor layer.",1e4,"rounded")}).always(function(){a.prop("disabled",!1),a.material_select()})}function buildGetTileUrl(e,a){return function(t,s){return["https://earthengine.googleapis.com/map",e,s,t.x,t.y].join("/")+"?token="+a}}function addMarkers(){!1===listenerHandle?($("#map div .gm-style div").css("cursor","crosshair"),$("#addMarkers").addClass("active"),region.setEditable(!1),listenerHandle=google.maps.event.addListener(map,"click",function(e){if(google.maps.geometry.poly.containsLocation(e.latLng,region)){var a=parseInt($(".classVal.active").attr("id")),t=$("li#"+a+" a .badge");t.text(parseInt(t.text())+1);var s=new google.maps.Marker({position:e.latLng,map:map,draggable:!0,icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,fillColor:classList[a].colour,fillOpacity:.6,strokeColor:"white",strokeWeight:.5,scale:4}});classList[a].markers.push(s)}}),$(".button-collapse").sideNav("hide")):($("#map div .gm-style div").css("cursor",""),$("#addMarkers").removeClass("active"),region.setEditable(!0),google.maps.event.removeListener(listenerHandle),listenerHandle=!1)}function markerVisibility(){var e=$("#marker-toggle"),a="1"===e.attr("data");classList.forEach(function(e){e.markers.forEach(function(e){e.setVisible(a)})}),e.attr("data",a?"0":"1")}function addClassifiedMap(e){$("#spinner").hide(),localStorage.setItem("layers",JSON.stringify(e)),e.forEach(function(e,a){var t={getTileUrl:buildGetTileUrl(e.mapid,e.token),tileSize:new google.maps.Size(256,256)},s=new google.maps.ImageMapType(t);classified?(map.overlayMapTypes.pop(),map.overlayMapTypes.push(s),addLayerControl(map.overlayMapTypes.length,e.label,!0)):(classified=!0,map.overlayMapTypes.push(s),addLayerControl(map.overlayMapTypes.length,e.label,!0))}),$("#classify").text("4. Reclassify!")}function getMapJSON(){return JSON.stringify({classes:getClasses(),region:getRegion()})}function loginClick(){window.onbeforeunload=null,localStorage.setItem("mapData",getMapJSON())}function oauthFalse(){$("#g-sign-in").show(),$("#g-download .waves-effect").addClass("subheader"),$("#g-sign-out").hide()}function oauthTrue(){$("#g-sign-in").hide(),$("#g-download .waves-effect").addClass("subheader"),$("#g-sign-out").show()}function reloadTraining(){var e=localStorage.getItem("mapData");null!=e?loadFromJSON(e):(addClass(),initRegion())}function signOut(){$.post("/logout"),$("#g-sign-in").show(),$("#g-download .waves-effect").addClass("subheader"),$("#g-sign-out").hide()}function addRegion(e){region&&region.setMap(null),region=new google.maps.Polygon({paths:e,strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.05,editable:!0,geodesic:!0,clickable:!1}),region.setMap(map)}function regionFix(e){if(e.length>0&&Array.isArray(e[0])){for(var a=[],t=0;t<e.length;t++)a.push({lat:e[t][0],lng:e[t][1]});return a}return e}function addRegionFocus(e,a){a=void 0!==a&&a;var t=new google.maps.LatLngBounds;if(a){e=regionFix(e),addRegion(e);for(var s=0;s<e.length;s++)t.extend(new google.maps.LatLng(e[s].lat,e[s].lng))}else{for(var n=[],s=0;s<e.length;s++)n.push({lat:e[s][1],lng:e[s][0]}),t.extend(new google.maps.LatLng(e[s][1],e[s][0]));addRegion(n)}map.fitBounds(t)}function regionPath(){return region.getPath().getArray().map(function(e){return{lat:e.lat(),lng:e.lng()}})}function reFocusRegion(){var e=map.getBounds().toJSON(),a=Math.abs(e.north-e.south)/4,t=Math.abs(e.east-e.west)/4,s={lat:e.north-a,lng:e.west+t},n={lat:e.north-a,lng:e.east-t},o={lat:e.south+a,lng:e.west+t},r={lat:e.south+a,lng:e.east-t},l=[s,n,r,o];region.setPaths(l)}function getRegion(){for(var e=region.getPath(),a=[],t=0;t<e.getLength();t++){var s=e.getAt(t);a.push({lat:s.lat(),lng:s.lng()})}return a}var listenerHandle=!1,classList=[],classified=!1,region=!1,colours=["#77AADD","#DDAA77","#77CCCC","#CC99BB","#DDDD77","#DD7788","#4477AA","#AA7744","#44AAAA","#AA4488","#AAAA44","#AA4455","#114477","#774411","#117777","#771155","#777711","#771122"],vis={mean:0,total_sd:1},initialize=function(e){google.charts.load("current",{packages:["corechart","bar"]});var a=new google.maps.LatLng(-35.8691162172,137.320622559),t={center:a,zoom:9,scaleControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},streetViewControl:!1,mapTypeId:google.maps.MapTypeId.SATELLITE};map=new google.maps.Map($("#map")[0],t),$("#spinner").hide(),$("#modal1").modal(),$("#modal2").modal(),$("#modal3").modal(),window.matchMedia("(max-width: 992px)").matches&&($("#mobile-modal").modal(),$("#mobile-modal").modal("open")),"true"===e?oauthTrue():(oauthFalse(),"reload"!==e&&(localStorage.removeItem("mapData"),localStorage.removeItem("layers"))),reloadTraining(),$("predictorVis").val("natural"),predictorVis(!0),localStorage.removeItem("mapData")};$(document).ready(function(){$(".demo").minicolors({inline:!0,change:function(e,a){updateRGB()},theme:"default"}),document.querySelector(".advContainer").addEventListener("change",function(){var e=[Math.max(Math.min(parseInt($(".advContainer .input-field input#r").val()),255),0).toString(16),Math.max(Math.min(parseInt($(".advContainer .input-field input#g").val()),255),0).toString(16),Math.max(Math.min(parseInt($(".advContainer .input-field input#b").val()),255),0).toString(16)];$.each(e,function(a,t){1===t.length&&(e[a]="0"+t)}),$("#colourTemplate .demo").minicolors("value","#"+e.join(""))}),$("#csv").on("change",function(){buildTrainingCSV(),this.value=null}),$("#json").on("change",function(){buildTrainingJSON(),this.value=null}),$("#kml").on("change",function(){buildTrainingKML(),this.value=null}),$(".button-collapse").sideNav(),$("select").material_select()});